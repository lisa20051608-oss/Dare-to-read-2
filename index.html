<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dare to Read ‚Äì H√†nh tr√¨nh 21 ng√†y ƒë·ªçc s√°ch</title>
  <style>
    :root{
      --vtb-blue:#003A8C;
      --vtb-cyan:#00AEEF;
      --vtb-red:#E60012;

      --ink:#0b1220;
      --muted: rgba(11,18,32,.62);
      --card: rgba(255,255,255,.92);
      --card2: rgba(255,255,255,.75);
      --stroke: rgba(11,18,32,.10);
      --shadow: 0 18px 55px rgba(0,0,0,.18);
      --radius: 18px;

      --ok:#13c26b;
      --warn:#ffb020;
      --bad:#ff4d4f;

      --btn:#0b1220;
      --btnText:#fff;

      --safeTop: env(safe-area-inset-top);
      --safeBot: env(safe-area-inset-bottom);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink); }
    body{
      overflow-x:hidden;
      background: linear-gradient(135deg, var(--vtb-blue) 0%, var(--vtb-cyan) 42%, var(--vtb-red) 100%);
      padding: calc(10px + var(--safeTop)) 12px calc(14px + var(--safeBot));
    }

    #bgCanvas{
      position:fixed; inset:0; z-index:-2;
      width:100vw; height:100vh;
      opacity:.28;
    }
    .veil{
      position:fixed; inset:0; z-index:-1;
      background: radial-gradient(1200px 700px at 30% 20%, rgba(255,255,255,.28), transparent 55%),
                  radial-gradient(900px 650px at 75% 70%, rgba(255,255,255,.22), transparent 55%);
      pointer-events:none;
    }

    .app{
      max-width: 420px;
      margin: 0 auto;
      min-height: calc(100vh - 24px - var(--safeTop) - var(--safeBot));
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius: 22px;
      background: rgba(255,255,255,.22);
      border: 1px solid rgba(255,255,255,.28);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(255,255,255,.75), rgba(255,255,255,.25));
      border:1px solid rgba(255,255,255,.35);
      display:grid; place-items:center;
      font-size:18px;
    }
    .brandText{ min-width:0; }
    .brandText b{ display:block; font-size:15px; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .brandText span{ display:block; font-size:12px; color:rgba(255,255,255,.92); opacity:.92; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .topActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      appearance:none; border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.22);
      color: rgba(255,255,255,.96);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:600;
      font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .pill.dark{
      background: rgba(11,18,32,.75);
      border-color: rgba(11,18,32,.20);
      color:#fff;
    }
    .pill:active{ transform: translateY(1px); }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardInner{ padding:14px; }

    .h1{ font-size:18px; margin:0 0 6px 0; }
    .sub{ margin:0; color:var(--muted); font-size:13px; line-height:1.35; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1 1 140px; min-width:0; }

    .input{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(11,18,32,.12);
      background: rgba(255,255,255,.9);
      outline:none;
      font-size:14px;
    }
    .input:focus{ border-color: rgba(0,174,239,.55); box-shadow: 0 0 0 4px rgba(0,174,239,.12); }

    .label{ font-size:12px; color:var(--muted); margin:0 0 6px 2px; }
    .help{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35; }

    .btn{
      appearance:none; border:0; cursor:pointer;
      background: var(--btn); color: var(--btnText);
      padding:12px 14px; border-radius: 14px;
      font-weight:700; font-size:14px;
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      width:100%;
    }
    .btn.secondary{
      background: rgba(255,255,255,.75);
      color: var(--ink);
      border:1px solid rgba(11,18,32,.10);
    }
    .btn:active{ transform: translateY(1px); }

    .divider{ height:1px; background: rgba(11,18,32,.10); margin:12px 0; }

    .avatarPick{
      display:flex; gap:10px;
    }
    .avatarBtn{
      flex:1;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(11,18,32,.12);
      background: rgba(255,255,255,.85);
      cursor:pointer;
      font-weight:700;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .avatarBtn.active{
      border-color: rgba(0,174,239,.55);
      box-shadow: 0 0 0 4px rgba(0,174,239,.12);
      background: #fff;
    }

    .userHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .userLeft{ min-width:0; }
    .userName{ font-size:20px; margin:0; display:flex; align-items:center; gap:10px; }
    .tagRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.82);
      border:1px solid rgba(11,18,32,.10);
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
    }

    .journeyTitle{ display:flex; align-items:center; gap:8px; }
    .journeyGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    .dayCell{
      border-radius: 16px;
      border:1px solid rgba(11,18,32,.10);
      background: rgba(255,255,255,.78);
      padding:10px 8px;
      min-height:72px;
      display:flex; flex-direction:column; gap:6px;
      justify-content:center;
      text-align:center;
      user-select:none;
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .dayCell.locked{
      opacity:.42;
      cursor:not-allowed;
      filter: grayscale(.2);
    }
    .dayCell.done{
      background: rgba(19,194,107,.10);
      border-color: rgba(19,194,107,.30);
    }
    .dayCell.current{
      background: rgba(11,18,32,.92);
      border-color: rgba(11,18,32,.25);
      color:#fff;
    }
    .dayCell .d{ font-weight:900; font-size:14px; }
    .dayCell .ic{ font-size:18px; line-height:1; }
    .blink{
      animation: blink 1.25s infinite ease-in-out;
    }
    @keyframes blink{
      0%,100%{ transform: translateY(0); opacity:1; }
      50%{ transform: translateY(-1px); opacity:.55; }
    }

    .legend{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: calc(14px + var(--safeBot));
      width:min(420px, calc(100vw - 24px));
      background: rgba(11,18,32,.92);
      color:#fff;
      border-radius: 16px;
      padding:12px 14px;
      box-shadow: 0 18px 55px rgba(0,0,0,.25);
      display:none;
      z-index:50;
      font-size:13px;
      line-height:1.35;
    }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tab{
      flex:1 1 auto;
      min-width: 120px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(11,18,32,.10);
      background: rgba(255,255,255,.78);
      font-weight:800;
      cursor:pointer;
      display:flex; gap:8px; align-items:center; justify-content:center;
    }
    .tab.active{
      background: rgba(11,18,32,.92);
      color:#fff;
      border-color: rgba(11,18,32,.25);
    }

    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th,td{ padding:10px 8px; border-bottom:1px solid rgba(11,18,32,.08); text-align:left; vertical-align:top; }
    th{ font-size:12px; color:var(--muted); text-transform:none; font-weight:900; }
    .right{ text-align:right; }
    .center{ text-align:center; }

    .actionsInline{ display:flex; gap:8px; flex-wrap:wrap; }
    .miniBtn{
      padding:9px 10px;
      border-radius: 14px;
      border:1px solid rgba(11,18,32,.10);
      background: rgba(255,255,255,.86);
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .miniBtn.danger{ background: rgba(255,77,79,.10); border-color: rgba(255,77,79,.25); }
    .miniBtn.primary{ background: rgba(0,174,239,.12); border-color: rgba(0,174,239,.28); }

    .quoteCard{
      border-radius: 18px;
      border: 1px dashed rgba(11,18,32,.20);
      background: rgba(255,255,255,.85);
      padding: 14px;
    }
    .quoteCard q{
      display:block;
      font-weight:900;
      font-size:14px;
      line-height:1.35;
      margin:0 0 8px 0;
    }
    .quoteCard .who{
      color:var(--muted);
      font-weight:800;
      font-size:12px;
    }

    .smallNote{
      font-size:12px; color:var(--muted); line-height:1.35;
    }

    [data-view]{ display:none; }
    [data-view].show{ display:block; }
  </style>
</head>

<body>
<canvas id="bgCanvas"></canvas>
<div class="veil"></div>

<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo">üìö</div>
      <div class="brandText">
        <b>Dare to Read</b>
        <span>H√†nh tr√¨nh 21 ng√†y ƒë·ªçc s√°ch</span>
      </div>
    </div>
    <div class="topActions">
      <button id="btnLogout" class="pill" style="display:none">ƒêƒÉng xu·∫•t</button>
      <button id="btnAdmin" class="pill" style="display:none">Admin</button>
      <button id="btnBack" class="pill" style="display:none">‚¨Ö Quay l·∫°i</button>
    </div>
  </div>

  <!-- LOGIN VIEW -->
  <div class="card" data-view="login">
    <div class="cardInner">
      <h2 class="h1">ƒêƒÉng nh·∫≠p</h2>
      <p class="sub">Vui l√≤ng nh·∫≠p th√¥ng tin theo t√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c Admin t·∫°o.</p>

      <div style="margin-top:12px">
        <div class="label">User AD (kh√¥ng @vietinbank.vn) ‚Äî kh√¥ng ph√¢n bi·ªát hoa/th∆∞·ªùng</div>
        <input id="loginUser" class="input" placeholder="vd: nguyenvana" autocomplete="username" />
        <div class="help">V√≠ d·ª•: nh·∫≠p <b>nguyenvana</b> (kh√¥ng nh·∫≠p @vietinbank.vn).</div>
      </div>

      <div style="margin-top:10px">
        <div class="label">M·∫≠t kh·∫©u</div>
        <input id="loginPass" class="input" type="password" placeholder="M·∫∑c ƒë·ªãnh: 1234" autocomplete="current-password" />
      </div>

      <div style="margin-top:10px">
        <div class="label">Ch·ªçn avatar</div>
        <div class="avatarPick">
          <button id="pickM" class="avatarBtn active" type="button">Nam üë®</button>
          <button id="pickF" class="avatarBtn" type="button">N·ªØ üë©</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="btnLogin" class="btn">ƒêƒÉng nh·∫≠p</button>
      </div>

      <div class="divider"></div>
      <div class="smallNote">
        <b>L∆∞u √Ω:</b> H·ªá th·ªëng ƒë√£ b·∫≠t ch·∫ø ƒë·ªô ghi/ƒë·ªçc Web App ƒë·ªÉ ch∆°i ƒëa thi·∫øt b·ªã.
      </div>
    </div>
  </div>

  <!-- HOME VIEW -->
  <div class="card" data-view="home">
    <div class="cardInner">
      <div class="userHeader">
        <div class="userLeft">
          <p class="userName" id="homeUserName">üëã demo01</p>
          <div class="tagRow">
            <div class="tag" id="homeAvatarTag">Avatar: Nam üë®</div>
            <div class="tag" id="homeRankTag">üèÖ Th·ª© h·∫°ng: #1</div>
            <div class="tag" id="homeDayTag">üìÖ Ng√†y hi·ªán t·∫°i: 1/21</div>
            <div class="tag" id="homeDoneTag">‚úÖ ƒê√£ ho√†n th√†nh: 0/21</div>
          </div>
        </div>
        <div class="tag" style="font-size:14px" id="homePointTag">‚≠ê 0 ƒëi·ªÉm</div>
      </div>

      <div class="divider"></div>

      <p class="sub"><b>M·ª•c ti√™u:</b> duy tr√¨ th√≥i quen ƒë·ªçc m·ªói ng√†y v√† ghi l·∫°i 1 ƒëi·ªÅu t√¢m ƒë·∫Øc ƒë·ªÉ √°p d·ª•ng v√†o c√¥ng vi·ªác/cu·ªôc s·ªëng.</p>

      <div style="margin-top:12px">
        <div class="journeyTitle">
          <h2 class="h1" style="margin:0">üó∫Ô∏è H√†nh tr√¨nh 21 ng√†y</h2>
        </div>
        <p class="sub" style="margin-top:4px">
          Ch·ªâ c√≥ <b>Ng√†y hi·ªán t·∫°i</b> ƒë∆∞·ª£c b·∫•m ƒë·ªÉ chia s·∫ª. Ho√†n th√†nh s·∫Ω c·ªông ‚≠ê <b>1 ƒëi·ªÉm</b>.
        </p>

        <div style="margin-top:10px">
          <button id="btnGoCurrent" class="btn" type="button">V√†o Ng√†y <span id="curDayBtnText">1</span></button>
        </div>

        <div class="journeyGrid" id="journeyGrid"></div>

        <div class="legend">
          <div class="tag">‚úÖ ƒê√£ ho√†n th√†nh</div>
          <div class="tag">‚ú® Ng√†y hi·ªán t·∫°i (nh·∫•p nh√°y)</div>
          <div class="tag">‚è≥ Ch∆∞a t·ªõi (m·ªù)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- DAY VIEW -->
  <div class="card" data-view="day">
    <div class="cardInner">
      <h2 class="h1" id="dayTitle">Ng√†y 1</h2>
      <p class="sub">Anh/Ch·ªã h√£y chia s·∫ª ƒëi·ªÅu t√¢m ƒë·∫Øc nh·∫•t c·ªßa bu·ªïi ƒë·ªçc s√°ch h√¥m nay.</p>

      <div style="margin-top:12px">
        <div class="label">N·ªôi dung chia s·∫ª (t·ªëi thi·ªÉu 15 k√Ω t·ª±, t·ªëi ƒëa 800 k√Ω t·ª±)</div>
        <textarea id="dayText" class="input" rows="7" style="resize:none" placeholder="Nh·∫≠p ƒëi·ªÅu t√¢m ƒë·∫Øc c·ªßa b·∫°n..."></textarea>
        <div class="help" id="charHint">0/800</div>
      </div>

      <div style="margin-top:12px" class="row">
        <div class="col">
          <button id="btnSubmitDay" class="btn">K·∫øt th√∫c</button>
        </div>
        <div class="col">
          <button id="btnCancelDay" class="btn secondary" type="button">Quay l·∫°i</button>
        </div>
      </div>

      <div class="divider"></div>
      <p class="smallNote" id="dayStatusNote">
        Ho√†n th√†nh h√¥m nay s·∫Ω nh·∫≠n ‚≠ê 1 ƒëi·ªÉm v√† 01 th·∫ª c√¢u n√≥i √Ω nghƒ©a v·ªÅ ƒë·ªçc s√°ch.
      </p>
    </div>
  </div>

  <!-- COMPLETE VIEW -->
  <div class="card" data-view="complete">
    <div class="cardInner">
      <h2 class="h1">üéâ Ho√†n th√†nh</h2>
      <p class="sub" id="completeMsg">Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh chia s·∫ª ƒëi·ªÅu t√¢m ƒë·∫Øc cho ng√†y h√¥m nay.</p>

      <div class="tagRow" style="margin-top:10px">
        <div class="tag" id="completePoint">‚≠ê B·∫°n nh·∫≠n ƒë∆∞·ª£c: 1 ƒëi·ªÉm</div>
        <div class="tag" id="completeTotal">‚≠ê T·ªïng ƒëi·ªÉm: 0</div>
      </div>

      <div style="margin-top:12px" class="quoteCard" id="quoteCard">
        <q id="quoteText">‚ÄúA room without books is like a body without a soul.‚Äù</q>
        <div class="who" id="quoteWho">‚Äî Cicero</div>
      </div>

      <div style="margin-top:12px">
        <button id="btnBackHome" class="btn">V·ªÅ trang ch·ªß</button>
      </div>

      <div class="divider"></div>
      <p class="smallNote">G·ª£i √Ω: ng√†y mai, b·∫°n ch·ªâ c·∫ßn ƒëƒÉng nh·∫≠p l·∫°i v√† b·∫•m v√†o ‚ÄúNg√†y hi·ªán t·∫°i‚Äù ƒë·ªÉ ti·∫øp t·ª•c.</p>
    </div>
  </div>

  <!-- ADMIN LOGIN VIEW -->
  <div class="card" data-view="adminLogin">
    <div class="cardInner">
      <h2 class="h1">üîß Admin Console</h2>
      <p class="sub">Nh·∫≠p m·∫≠t kh·∫©u Admin ƒë·ªÉ v√†o thi·∫øt l·∫≠p.</p>

      <div style="margin-top:12px">
        <div class="label">M·∫≠t kh·∫©u Admin</div>
        <input id="adminPass" class="input" type="password" placeholder="nhap mat khau" />
      </div>

      <div style="margin-top:12px">
        <button id="btnAdminLogin" class="btn">V√†o Admin</button>
      </div>

      <div class="divider"></div>
      <p class="smallNote">
        Admin c√≥ th·ªÉ t·∫°o t√†i kho·∫£n, c·∫•u h√¨nh Web App/Sheet, xem dashboard v√† reset to√†n b·ªô.
      </p>
    </div>
  </div>

  <!-- ADMIN VIEW -->
  <div class="card" data-view="admin">
    <div class="cardInner">
      <h2 class="h1">üîß Admin Console ‚Äì Dare to Read</h2>
      <p class="sub">Qu·∫£n l√Ω t√†i kho·∫£n, c·∫•u h√¨nh Web App (ghi Sheet), dashboard, reset.</p>

      <div class="tabs">
        <button class="tab active" data-tab="accounts">üë• T√†i kho·∫£n</button>
        <button class="tab" data-tab="webapp">üßæ Web App / Sheet</button>
        <button class="tab" data-tab="dash">üìä Dashboard</button>
        <button class="tab" data-tab="reset">‚ôªÔ∏è Reset</button>
      </div>

      <!-- ACCOUNTS TAB -->
      <div id="tabAccounts" style="margin-top:12px">
        <h3 class="h1" style="font-size:16px">T·∫°o / c·∫≠p nh·∫≠t t√†i kho·∫£n</h3>

        <div class="row" style="margin-top:8px">
          <div class="col">
            <div class="label">User AD (kh√¥ng @vietinbank.vn)</div>
            <input id="adUser" class="input" placeholder="vd: demo01" />
          </div>
          <div class="col">
            <div class="label">Password</div>
            <input id="adPass" class="input" placeholder="vd: 1234" />
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="label">Avatar (M ho·∫∑c F)</div>
          <select id="adAvatar" class="input">
            <option value="M">Nam üë® (M)</option>
            <option value="F">N·ªØ üë© (F)</option>
          </select>
        </div>

        <div style="margin-top:12px" class="row">
          <div class="col">
            <button id="btnUpsertUser" class="btn">T·∫°o / C·∫≠p nh·∫≠t</button>
          </div>
        </div>

        <div class="divider"></div>

        <h3 class="h1" style="font-size:16px">Import / Export CSV (Excel)</h3>
        <p class="sub">M·∫´u CSV: <code>user,password,avatar</code> (avatar = M ho·∫∑c F)</p>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <button id="btnDownloadCSV" class="btn secondary" type="button">‚¨áÔ∏è T·∫£i m·∫´u CSV</button>
          </div>
          <div class="col">
            <button id="btnExportCSV" class="btn secondary" type="button">‚¨ÜÔ∏è Export CSV</button>
          </div>
        </div>

        <div style="margin-top:10px" class="row">
          <div class="col">
            <input id="csvFile" type="file" accept=".csv,text/csv" class="input" />
          </div>
          <div class="col">
            <button id="btnImportCSV" class="btn" type="button">Import CSV</button>
          </div>
        </div>

        <div class="divider"></div>

        <h3 class="h1" style="font-size:16px">Danh s√°ch t√†i kho·∫£n</h3>
        <div style="overflow:auto; border-radius:14px; border:1px solid rgba(11,18,32,.08); background:rgba(255,255,255,.75)">
          <table id="userTable"></table>
        </div>
      </div>

      <!-- WEBAPP TAB -->
      <div id="tabWebapp" style="margin-top:12px; display:none">
        <h3 class="h1" style="font-size:16px">Thi·∫øt l·∫≠p Web App / Sheet</h3>
        <p class="sub">
          D√°n URL Web App ƒë·ªÉ game ghi/ƒë·ªçc d·ªØ li·ªáu (ch∆°i ƒëa thi·∫øt b·ªã). C√≥ th·ªÉ ƒë·ªïi URL t·∫°i ƒë√¢y.
        </p>

        <div style="margin-top:10px">
          <div class="label">Web App URL (Google Apps Script)</div>
          <input id="cfgWebAppUrl" class="input" placeholder="vd: https://script.google.com/macros/s/XXXX/exec" />
          <div class="help">ƒê·ªÉ t·∫Øt ghi Sheet: ƒë·ªÉ tr·ªëng URL.</div>
        </div>

        <div style="margin-top:10px">
          <div class="label">Google Form Link (ƒë·ªÉ Admin xem & t·∫£i k·∫øt qu·∫£)</div>
          <input id="cfgFormUrl" class="input" placeholder="vd: link Google Form / link Responses Sheet" />
        </div>

        <div style="margin-top:12px" class="row">
          <div class="col">
            <button id="btnSaveConfig" class="btn">L∆∞u c·∫•u h√¨nh</button>
          </div>
          <div class="col">
            <button id="btnTestWebApp" class="btn secondary" type="button">Test k·∫øt n·ªëi</button>
          </div>
        </div>

        <div class="divider"></div>
        <div class="quoteCard">
          <q>G·ª£i √Ω chu·∫©n ho√°</q>
          <div class="smallNote" style="margin-top:8px">
            Web App n√™n h·ªó tr·ª£ action JSON: <code>ping</code>, <code>getAll</code>, <code>upsertUser</code>,
            <code>saveDay</code>, <code>resetAll</code>.
          </div>
        </div>

        <div class="divider"></div>
        <div class="smallNote">
          Link Form hi·ªán t·∫°i: <span id="viewFormLink" style="font-weight:900"></span>
        </div>
      </div>

      <!-- DASH TAB -->
      <div id="tabDash" style="margin-top:12px; display:none">
        <h3 class="h1" style="font-size:16px">Dashboard</h3>
        <p class="sub">Th·ª© h·∫°ng theo ƒëi·ªÉm & th·ªùi gian ƒë·∫°t m·ªëc ƒëi·ªÉm (ƒë·∫°t s·ªõm h∆°n x·∫øp cao h∆°n khi b·∫±ng ƒëi·ªÉm).</p>

        <div style="overflow:auto; border-radius:14px; border:1px solid rgba(11,18,32,.08); background:rgba(255,255,255,.75)">
          <table id="rankTable"></table>
        </div>

        <div class="divider"></div>
        <h3 class="h1" style="font-size:16px">S·ªë l∆∞·ª£ng ng∆∞·ªùi tham gia theo ng√†y</h3>
        <p class="sub">ƒê·∫øm s·ªë user ƒë√£ ho√†n th√†nh t·ª´ng ng√†y (Day 1..21).</p>

        <div style="overflow:auto; border-radius:14px; border:1px solid rgba(11,18,32,.08); background:rgba(255,255,255,.75)">
          <table id="participationTable"></table>
        </div>
      </div>

      <!-- RESET TAB -->
      <div id="tabReset" style="margin-top:12px; display:none">
        <h3 class="h1" style="font-size:16px">Reset to√†n b·ªô</h3>
        <p class="sub">Xo√° t·∫•t c·∫£ ng∆∞·ªùi ch∆°i & k·∫øt qu·∫£. C·∫ßn nh·∫≠p m·∫≠t kh·∫©u Admin ƒë·ªÉ x√°c nh·∫≠n.</p>

        <div style="margin-top:10px">
          <div class="label">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u Admin</div>
          <input id="resetPass" class="input" type="password" placeholder="Ab123456" />
        </div>

        <div style="margin-top:12px">
          <button id="btnResetAll" class="btn" style="background: rgba(255,77,79,.92)">Reset to√†n b·ªô game</button>
        </div>

        <div class="divider"></div>
        <p class="smallNote">
          Reset s·∫Ω xo√° to√†n b·ªô t√†i kho·∫£n hi·ªán t·∫°i & ti·∫øn ƒë·ªô. N·∫øu ƒë√£ b·∫≠t Web App/Sheet, game s·∫Ω g·ªçi reset l√™n Web App.
        </p>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
/* =========================================================
   CONFIG
   ========================================================= */
const CONFIG = {
  APP_TITLE: "Dare to Read ‚Äì H√†nh tr√¨nh 21 ng√†y ƒë·ªçc s√°ch",
  DAYS: 21,

  QUOTES: [
    { text: "M·ªôt cƒÉn ph√≤ng kh√¥ng c√≥ s√°ch gi·ªëng nh∆∞ m·ªôt c∆° th·ªÉ kh√¥ng c√≥ linh h·ªìn.", who: "Cicero" },
    { text: "ƒê·ªçc s√°ch l√† c√°ch r·∫ª nh·∫•t ƒë·ªÉ ƒëi du l·ªãch.", who: "Khuy·∫øt danh" },
    { text: "S√°ch l√† ng∆∞·ªùi b·∫°n l·∫∑ng l·∫Ω nh∆∞ng trung th√†nh nh·∫•t.", who: "Khuy·∫øt danh" },
    { text: "H√¥m nay ƒë·ªçc m·ªôt trang, ng√†y mai th√™m m·ªôt trang ‚Äî r·ªìi b·∫°n s·∫Ω ƒëi r·∫•t xa.", who: "Khuy·∫øt danh" },
    { text: "M·ªôt cu·ªën s√°ch hay m·ªü ra m·ªôt c√°nh c·ª≠a m·ªõi trong suy nghƒ©.", who: "Khuy·∫øt danh" },
    { text: "B·∫°n c√†ng ƒë·ªçc, b·∫°n c√†ng hi·ªÉu. B·∫°n c√†ng hi·ªÉu, b·∫°n c√†ng m·∫°nh m·∫Ω.", who: "Khuy·∫øt danh" },
    { text: "ƒê·ªçc s√°ch kh√¥ng l√†m b·∫°n gi√†u ngay, nh∆∞ng l√†m b·∫°n s√¢u s·∫Øc h∆°n m·ªói ng√†y.", who: "Khuy·∫øt danh" },
    { text: "S√°ch l√† √°nh s√°ng cho nh·ªØng ng√†y ta l·∫°c h∆∞·ªõng.", who: "Khuy·∫øt danh" },
    { text: "H·ªçc h·ªèi kh√¥ng bao gi·ªù l√† mu·ªôn ‚Äî ch·ªâ c·∫ßn b·∫°n b·∫Øt ƒë·∫ßu.", who: "Khuy·∫øt danh" },
    { text: "M·ªôt √Ω t∆∞·ªüng hay c√≥ th·ªÉ thay ƒë·ªïi c·∫£ m·ªôt ƒë·ªùi ng∆∞·ªùi ‚Äî v√† ƒë√¥i khi n√≥ n·∫±m trong m·ªôt trang s√°ch.", who: "Khuy·∫øt danh" },
    { text: "ƒê·ªçc s√°ch gi√∫p ta s·ªëng nhi·ªÅu cu·ªôc ƒë·ªùi trong m·ªôt cu·ªôc ƒë·ªùi.", who: "Khuy·∫øt danh" },
    { text: "Tri th·ª©c l√† kho·∫£n ƒë·∫ßu t∆∞ c√≥ l√£i su·∫•t cao nh·∫•t.", who: "Benjamin Franklin (th∆∞·ªùng ƒë∆∞·ª£c tr√≠ch d·∫´n)" },
    { text: "N·∫øu b·∫°n mu·ªën ƒëi nhanh h√£y ƒëi m·ªôt m√¨nh, mu·ªën ƒëi xa h√£y ƒë·ªçc c√πng nhau.", who: "Ph·ªèng theo ng·∫°n ng·ªØ" },
    { text: "ƒê·ªçc s√°ch l√† luy·ªán t√¢m tr√≠ gi·ªëng nh∆∞ th·ªÉ d·ª•c luy·ªán c∆° b·∫Øp.", who: "Joseph Addison (th∆∞·ªùng ƒë∆∞·ª£c tr√≠ch d·∫´n)" },
    { text: "ƒêi·ªÅu nh·ªè l√†m m·ªói ng√†y s·∫Ω t·∫°o n√™n ƒëi·ªÅu l·ªõn theo th·ªùi gian.", who: "Khuy·∫øt danh" },
    { text: "S√°ch cho ta c√¢u h·ªèi ƒë√∫ng, tr∆∞·ªõc khi cho ta c√¢u tr·∫£ l·ªùi ƒë√∫ng.", who: "Khuy·∫øt danh" },
    { text: "Th√≥i quen t·ªët kh√¥ng c·∫ßn ho√†n h·∫£o ‚Äî ch·ªâ c·∫ßn ƒë·ªÅu ƒë·∫∑n.", who: "Khuy·∫øt danh" },
    { text: "ƒê·ªçc ƒë·ªÉ hi·ªÉu m√¨nh, hi·ªÉu ng∆∞·ªùi, hi·ªÉu ƒë·ªùi.", who: "Khuy·∫øt danh" },
    { text: "M·ªói ng√†y m·ªôt b∆∞·ªõc, 21 ng√†y th√†nh th√≥i quen.", who: "Khuy·∫øt danh" },
    { text: "T∆∞ duy thay ƒë·ªïi khi b·∫°n ƒë·ªçc nh·ªØng ƒëi·ªÅu m·ªõi.", who: "Khuy·∫øt danh" },
    { text: "S√°ch l√† c√¢y c·∫ßu gi·ªØa tr·∫£i nghi·ªám v√† tr∆∞·ªüng th√†nh.", who: "Khuy·∫øt danh" },
  ],

  ADMIN_PASSWORD: "Ab123456",
  DEFAULT_USER_PASSWORD: "1234",

  // ‚úÖ PRE-FILLED Web App URL (your deployed URL)
  WEBAPP_URL: "https://script.google.com/macros/s/AKfycbzZfeTPmYh0EP2IvqOCeCXeStCiwz38BuA8VjwzsosLuLswUBA-mAMMGdZ8AtDt_2Uwvw/exec",

  GOOGLE_FORM_URL: ""
};

const LS_KEY = "dare_to_read_store_v1";
const SESSION_KEY = "dare_to_read_session_v1";

let store = loadStore();
let session = loadSession();

/* =========================================================
   Helpers
   ========================================================= */
function nowTs(){ return Date.now(); }
function normUser(u){ return (u||"").trim().toLowerCase(); }
function avatarLabel(a){ return a === "F" ? "N·ªØ üë©" : "Nam üë®"; }
function fmtDateTime(ts){
  if(!ts) return "-";
  const d = new Date(ts);
  const pad = (n)=> String(n).padStart(2,"0");
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
}
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> el.style.display = "none", 2600);
}
function saveStore(){
  store.meta.updatedAt = nowTs();
  localStorage.setItem(LS_KEY, JSON.stringify(store));
}
function loadStore(){
  const raw = localStorage.getItem(LS_KEY);
  const base = {
    users: {},
    config: { webAppUrl: CONFIG.WEBAPP_URL || "", formUrl: CONFIG.GOOGLE_FORM_URL || "" },
    meta: { updatedAt: nowTs() }
  };
  if(!raw){
    // seed (optional)
    base.users["demo01"] = { password: "1234", avatar:"M", createdAt: nowTs(), progress:{} };
    base.users["demo02"] = { password: "1234", avatar:"M", createdAt: nowTs(), progress:{} };
    localStorage.setItem(LS_KEY, JSON.stringify(base));
    return base;
  }
  try{
    const parsed = JSON.parse(raw);
    parsed.config = parsed.config || base.config;
    parsed.users = parsed.users || {};
    parsed.meta = parsed.meta || base.meta;

    // ‚úÖ ensure default webAppUrl if empty
    if(!parsed.config.webAppUrl && CONFIG.WEBAPP_URL) parsed.config.webAppUrl = CONFIG.WEBAPP_URL;

    return parsed;
  }catch(e){
    localStorage.setItem(LS_KEY, JSON.stringify(base));
    return base;
  }
}
function saveSession(){ localStorage.setItem(SESSION_KEY, JSON.stringify(session)); }
function loadSession(){
  const raw = localStorage.getItem(SESSION_KEY);
  if(!raw) return { user:null, avatar:"M" };
  try{ return JSON.parse(raw); }catch(e){ return { user:null, avatar:"M" }; }
}

function getWebAppUrl(){ return (store.config?.webAppUrl || "").trim(); }
function getFormUrl(){ return (store.config?.formUrl || "").trim(); }

/* =========================================================
   WebApp calls
   ========================================================= */
async function webappPost(payload){
  const url = getWebAppUrl();
  if(!url) return { ok:false, offline:true, error:"NO_WEBAPP_URL" };
  try{
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); }catch(_){ data = { raw:text }; }
    return { ok:true, data };
  }catch(err){
    return { ok:false, offline:true, error: String(err) };
  }
}

/* =========================================================
   ‚úÖ FIX: Multi-device sync from server
   ========================================================= */
function ensureUser(user){
  if(!store.users[user]){
    store.users[user] = {
      password: CONFIG.DEFAULT_USER_PASSWORD,
      avatar: "M",
      createdAt: nowTs(),
      progress: {}
    };
  }
  if(!store.users[user].progress) store.users[user].progress = {};
  if(!store.users[user].createdAt) store.users[user].createdAt = nowTs();
}
function applyServerUsers_(serverUsers){
  // serverUsers: [{user,password,avatar,points,doneDays,reachedAtISO}]
  serverUsers.forEach(su=>{
    const user = normUser(su.user);
    if(!user) return;

    ensureUser(user);
    const u = store.users[user];

    u.password = String(su.password || CONFIG.DEFAULT_USER_PASSWORD);
    u.avatar = (String(su.avatar || "M").toUpperCase()==="F") ? "F" : "M";

    // rebuild progress from doneDays so every device gets same points
    const done = Array.isArray(su.doneDays) ? su.doneDays : [];
    const baseTs = Date.parse(su.reachedAtISO || "") || nowTs();

    // create a monotonic timeline (best-effort) to support ranking tie-break
    const prog = {};
    done.sort((a,b)=>a-b).forEach((d, idx)=>{
      prog[String(d)] = {
        ts: baseTs - (done.length - 1 - idx), // ensure increasing by day
        text: "",
        quoteIndex: (d-1) % CONFIG.QUOTES.length
      };
    });
    u.progress = prog;
  });
}
async function syncFromServer(){
  const url = getWebAppUrl();
  if(!url) return { ok:false, offline:true };

  const res = await webappPost({ action:"getAll", ts: nowTs() });
  if(!res?.ok || !res.data?.ok || !Array.isArray(res.data.users)) return { ok:false };

  applyServerUsers_(res.data.users);
  saveStore();
  return { ok:true, count: res.data.users.length };
}

/* =========================================================
   Business logic
   ========================================================= */
function getUser(user){ return store.users[user] || null; }
function completedCount(u){ return Object.keys(u?.progress || {}).length; }
function totalPoints(u){ return completedCount(u); }
function currentDay(u){
  const done = completedCount(u);
  return clamp(done + 1, 1, CONFIG.DAYS);
}
function timeReachedScore(u){
  const p = u?.progress || {};
  const entries = Object.entries(p).map(([day, obj])=> obj?.ts || 0).filter(Boolean);
  if(entries.length === 0) return 0;
  return Math.max(...entries);
}
function rankingList(){
  const arr = Object.entries(store.users).map(([user, u])=>{
    const points = totalPoints(u);
    const t = timeReachedScore(u) || u.createdAt || 0;
    return { user, avatar: u.avatar || "M", points, reachedAt: t, done: completedCount(u) };
  });
  arr.sort((a,b)=>{
    if(b.points !== a.points) return b.points - a.points;
    if(a.reachedAt !== b.reachedAt) return a.reachedAt - b.reachedAt;
    return a.user.localeCompare(b.user);
  });
  return arr;
}
function userRank(user){
  const list = rankingList();
  const idx = list.findIndex(x=> x.user === user);
  return idx >= 0 ? idx+1 : "-";
}

/* =========================================================
   Views
   ========================================================= */
function showView(name){
  document.querySelectorAll("[data-view]").forEach(el=>{
    el.classList.toggle("show", el.getAttribute("data-view") === name);
  });

  const btnBack = document.getElementById("btnBack");
  const btnLogout = document.getElementById("btnLogout");
  const btnAdmin = document.getElementById("btnAdmin");

  if(name === "login"){
    btnBack.style.display = "none";
    btnLogout.style.display = "none";
    btnAdmin.style.display = "none";
  }else if(name === "home"){
    btnBack.style.display = "none";
    btnLogout.style.display = "inline-flex";
    btnAdmin.style.display = "inline-flex";
  }else if(name === "day" || name === "complete"){
    btnBack.style.display = "inline-flex";
    btnLogout.style.display = "inline-flex";
    btnAdmin.style.display = "inline-flex";
  }else if(name === "adminLogin" || name === "admin"){
    btnBack.style.display = "inline-flex";
    btnLogout.style.display = "inline-flex";
    btnAdmin.style.display = "none";
  }
}

/* =========================================================
   UI rendering
   ========================================================= */
function renderHome(){
  const user = session.user;
  if(!user) return;

  ensureUser(user);
  const u = getUser(user);
  const pts = totalPoints(u);
  const done = completedCount(u);
  const cur = currentDay(u);
  const rank = userRank(user);

  document.getElementById("homeUserName").textContent = `üëã ${user}`;
  document.getElementById("homeAvatarTag").textContent = `Avatar: ${avatarLabel(u.avatar || session.avatar || "M")}`;
  document.getElementById("homeRankTag").textContent = `üèÖ Th·ª© h·∫°ng: #${rank}`;
  document.getElementById("homeDayTag").textContent = `üìÖ Ng√†y hi·ªán t·∫°i: ${cur}/${CONFIG.DAYS}`;
  document.getElementById("homeDoneTag").textContent = `‚úÖ ƒê√£ ho√†n th√†nh: ${done}/${CONFIG.DAYS}`;
  document.getElementById("homePointTag").textContent = `‚≠ê ${pts} ƒëi·ªÉm`;
  document.getElementById("curDayBtnText").textContent = String(cur);

  const grid = document.getElementById("journeyGrid");
  grid.innerHTML = "";
  for(let d=1; d<=CONFIG.DAYS; d++){
    const cell = document.createElement("div");
    const isDone = !!u.progress?.[String(d)];
    const isCurrent = (d === cur);
    const isLocked = (d > cur);

    cell.className = "dayCell" + (isDone ? " done" : "") + (isCurrent ? " current" : "") + (isLocked ? " locked" : "");
    cell.innerHTML = `
      <div class="d">Ng√†y ${d}</div>
      <div class="ic">${isDone ? "‚úÖ" : (isCurrent ? "<span class='blink'>‚ú®</span>" : "‚è≥")}</div>
    `;
    if(!isLocked){
      cell.addEventListener("click", ()=>{
        if(d !== cur){ toast("Ch·ªâ c√≥ Ng√†y hi·ªán t·∫°i ƒë∆∞·ª£c b·∫•m ƒë·ªÉ chia s·∫ª."); return; }
        openDay(cur);
      });
    }else{
      cell.addEventListener("click", ()=> toast("Ch∆∞a t·ªõi ng√†y n√†y."));
    }
    grid.appendChild(cell);
  }

  saveStore();
}

function openDay(day){
  const user = session.user;
  const u = getUser(user);
  const cur = currentDay(u);
  if(day !== cur){ toast("Ch·ªâ c√≥ Ng√†y hi·ªán t·∫°i ƒë∆∞·ª£c b·∫•m ƒë·ªÉ chia s·∫ª."); return; }
  if(u.progress?.[String(day)]){ toast("Ng√†y n√†y ƒë√£ ho√†n th√†nh."); return; }

  document.getElementById("dayTitle").textContent = `Ng√†y ${day}`;
  const ta = document.getElementById("dayText");
  ta.value = "";
  document.getElementById("charHint").textContent = `0/800`;
  showView("day");
}

function renderAdminTables(){
  const tbl = document.getElementById("userTable");
  const rows = rankingList().map((x)=> {
    const u = getUser(x.user);
    return `
      <tr>
        <td style="font-weight:900">${x.user}</td>
        <td>${avatarLabel(u.avatar || "M")}</td>
        <td class="center">‚≠ê ${x.points}</td>
        <td class="center">${x.done}/${CONFIG.DAYS}</td>
        <td>
          <div class="actionsInline">
            <button class="miniBtn primary" data-act="resetUser" data-user="${x.user}">Reset user</button>
            <button class="miniBtn danger" data-act="deleteUser" data-user="${x.user}">X√≥a</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  tbl.innerHTML = `
    <thead>
      <tr>
        <th>User</th>
        <th>Avatar</th>
        <th class="center">ƒêi·ªÉm</th>
        <th class="center">Ho√†n th√†nh</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody>${rows || ""}</tbody>
  `;

  tbl.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const act = btn.getAttribute("data-act");
      const user = btn.getAttribute("data-user");
      if(!user) return;

      if(act === "resetUser"){
        store.users[user] && (store.users[user].progress = {});
        saveStore();

        await webappPost({ action:"resetUser", user });
        await syncFromServer();

        toast(`ƒê√£ reset ti·∫øn ƒë·ªô: ${user}`);
        renderAdminTables();
        renderDash();
      }

      if(act === "deleteUser"){
        if(!confirm(`X√≥a user ${user}? (X√≥a c·∫£ ti·∫øn ƒë·ªô)`)) return;
        delete store.users[user];
        saveStore();

        await webappPost({ action:"deleteUser", user });
        await syncFromServer();

        toast(`ƒê√£ x√≥a: ${user}`);
        renderAdminTables();
        renderDash();
      }
    });
  });
}

function renderDash(){
  const list = rankingList();

  const rt = document.getElementById("rankTable");
  rt.innerHTML = `
    <thead>
      <tr>
        <th class="center">#</th>
        <th>User</th>
        <th class="center">ƒêi·ªÉm</th>
        <th>M·ªëc ƒëi·ªÉm ƒë·∫°t l√∫c</th>
      </tr>
    </thead>
    <tbody>
      ${list.map((x, idx)=>`
        <tr>
          <td class="center" style="font-weight:900">${idx+1}</td>
          <td style="font-weight:900">${x.user}</td>
          <td class="center">‚≠ê ${x.points}</td>
          <td>${x.points === 0 ? "-" : fmtDateTime(x.reachedAt)}</td>
        </tr>
      `).join("")}
    </tbody>
  `;

  const counts = Array(CONFIG.DAYS).fill(0);
  Object.values(store.users).forEach(u=>{
    for(let d=1; d<=CONFIG.DAYS; d++){
      if(u.progress?.[String(d)]) counts[d-1] += 1;
    }
  });

  const pt = document.getElementById("participationTable");
  pt.innerHTML = `
    <thead>
      <tr>
        <th>Ng√†y</th>
        <th class="right">S·ªë ng∆∞·ªùi ƒë√£ tham gia</th>
      </tr>
    </thead>
    <tbody>
      ${counts.map((c, i)=>`
        <tr>
          <td style="font-weight:900">Ng√†y ${i+1}</td>
          <td class="right" style="font-weight:900">${c}</td>
        </tr>
      `).join("")}
    </tbody>
  `;
}

function setAdminTab(tab){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.getAttribute("data-tab") === tab);
  });
  document.getElementById("tabAccounts").style.display = (tab==="accounts") ? "" : "none";
  document.getElementById("tabWebapp").style.display = (tab==="webapp") ? "" : "none";
  document.getElementById("tabDash").style.display = (tab==="dash") ? "" : "none";
  document.getElementById("tabReset").style.display = (tab==="reset") ? "" : "none";
}

/* =========================================================
   Day submit (‚úÖ submit -> save -> syncFromServer)
   ========================================================= */
async function submitDay(){
  const user = session.user;
  const u = getUser(user);
  const day = currentDay(u);

  const text = (document.getElementById("dayText").value || "").trim();
  if(text.length < 15){ toast("N·ªôi dung t·ªëi thi·ªÉu 15 k√Ω t·ª±."); return; }
  if(text.length > 800){ toast("N·ªôi dung t·ªëi ƒëa 800 k√Ω t·ª±."); return; }

  const quoteIndex = (day-1) % CONFIG.QUOTES.length;
  const payload = { text, ts: nowTs(), quoteIndex };

  u.progress[String(day)] = payload;
  u.avatar = u.avatar || session.avatar || "M";
  saveStore();

  const syncRes = await webappPost({
    action: "saveDay",
    user,
    avatar: u.avatar,
    day,
    text,
    ts: payload.ts,
    pointsGained: 1
  });

  // ‚úÖ refresh from server so other devices/admin are consistent
  await syncFromServer();

  const pts = totalPoints(getUser(user));
  document.getElementById("completePoint").textContent = "‚≠ê B·∫°n nh·∫≠n ƒë∆∞·ª£c: 1 ƒëi·ªÉm";
  document.getElementById("completeTotal").textContent = `‚≠ê T·ªïng ƒëi·ªÉm: ${pts}`;

  const q = CONFIG.QUOTES[quoteIndex] || CONFIG.QUOTES[0];
  document.getElementById("quoteText").textContent = `‚Äú${q.text}‚Äù`;
  document.getElementById("quoteWho").textContent = `‚Äî ${q.who}`;

  showView("complete");

  if(syncRes.ok && syncRes.data && syncRes.data.ok === false){
    // server returned an error object
    toast("ƒê√£ l∆∞u local. Server b√°o l·ªói: " + (syncRes.data.error || "UNKNOWN"));
  }
}

/* =========================================================
   Admin actions (‚úÖ call server -> syncFromServer)
   ========================================================= */
async function upsertUserFromAdmin(){
  const user = normUser(document.getElementById("adUser").value);
  const pass = (document.getElementById("adPass").value || "").trim() || CONFIG.DEFAULT_USER_PASSWORD;
  const avatar = (document.getElementById("adAvatar").value || "M").trim();

  if(!user){ toast("Vui l√≤ng nh·∫≠p User AD."); return; }

  ensureUser(user);
  store.users[user].password = pass;
  store.users[user].avatar = (avatar === "F") ? "F" : "M";
  saveStore();

  await webappPost({ action:"upsertUser", user, password: pass, avatar: store.users[user].avatar });
  await syncFromServer();

  toast("ƒê√£ t·∫°o/c·∫≠p nh·∫≠t t√†i kho·∫£n.");
  renderAdminTables();
  renderDash();
}

function downloadSampleCSV(){
  const csv = "user,password,avatar\n" +
              "demo01,1234,M\n" +
              "demo02,1234,M\n";
  downloadText(csv, "dare_to_read_accounts_sample.csv");
}
function exportCSV(){
  const lines = ["user,password,avatar"];
  Object.entries(store.users).forEach(([user,u])=>{
    lines.push(`${user},${escapeCsv(u.password || "1234")},${u.avatar || "M"}`);
  });
  downloadText(lines.join("\n"), "dare_to_read_accounts_export.csv");
}
function escapeCsv(s){
  const t = String(s ?? "");
  if(/[",\n]/.test(t)) return `"${t.replaceAll('"','""')}"`;
  return t;
}
function downloadText(text, filename){
  const blob = new Blob([text], { type:"text/csv;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}
function parseCSV(text){
  const rows = [];
  let i=0, field="", row=[], inQuotes=false;

  const pushField = ()=>{ row.push(field); field=""; };
  const pushRow = ()=>{ if(row.length) rows.push(row); row=[]; };

  while(i < text.length){
    const c = text[i];
    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ field += '"'; i+=2; continue; }
        inQuotes = false; i++; continue;
      }
      field += c; i++; continue;
    }else{
      if(c === '"'){ inQuotes = true; i++; continue; }
      if(c === ","){ pushField(); i++; continue; }
      if(c === "\n"){ pushField(); pushRow(); i++; continue; }
      if(c === "\r"){ i++; continue; }
      field += c; i++; continue;
    }
  }
  pushField(); pushRow();
  return rows;
}
async function importCSVFile(file){
  const text = await file.text();
  const rows = parseCSV(text);
  if(!rows.length){ toast("CSV tr·ªëng."); return; }

  const header = rows[0].map(x=> (x||"").trim().toLowerCase());
  const idxUser = header.indexOf("user");
  const idxPass = header.indexOf("password");
  const idxAv   = header.indexOf("avatar");

  if(idxUser < 0){ toast("CSV thi·∫øu c·ªôt user."); return; }

  let count = 0;
  const payloadUsers = [];

  for(let r=1; r<rows.length; r++){
    const cols = rows[r];
    const user = normUser(cols[idxUser] || "");
    if(!user) continue;

    const pass = (idxPass>=0 ? (cols[idxPass]||"").trim() : "") || CONFIG.DEFAULT_USER_PASSWORD;
    const avRaw = idxAv>=0 ? (cols[idxAv]||"").trim().toUpperCase() : "M";
    const avatar = (avRaw === "F") ? "F" : "M";

    ensureUser(user);
    store.users[user].password = pass;
    store.users[user].avatar = avatar;
    count++;

    payloadUsers.push({ user, password: pass, avatar });
  }
  saveStore();

  await webappPost({ action:"importUsers", users: payloadUsers });
  await syncFromServer();

  toast(`ƒê√£ import ${count} t√†i kho·∫£n.`);
  renderAdminTables();
  renderDash();
}

async function saveAdminConfig(){
  store.config.webAppUrl = (document.getElementById("cfgWebAppUrl").value || "").trim();
  store.config.formUrl   = (document.getElementById("cfgFormUrl").value || "").trim();
  saveStore();
  document.getElementById("viewFormLink").textContent = store.config.formUrl ? store.config.formUrl : "(ch∆∞a thi·∫øt l·∫≠p)";
  toast("ƒê√£ l∆∞u c·∫•u h√¨nh.");

  // ‚úÖ if URL changed, immediately sync to validate
  if(getWebAppUrl()){
    await syncFromServer();
    renderAdminTables();
    renderDash();
  }
}

async function testWebApp(){
  const url = (document.getElementById("cfgWebAppUrl").value || "").trim();
  store.config.webAppUrl = url;
  saveStore();

  const res = await webappPost({ action:"ping", ts: nowTs() });
  if(res.ok && res.data && res.data.ok !== false){
    toast("K·∫øt n·ªëi Web App: OK");
  }else{
    toast("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Web App. Ki·ªÉm tra l·∫°i URL ho·∫∑c quy·ªÅn Deploy.");
  }
}

async function resetAll(){
  const pass = (document.getElementById("resetPass").value || "").trim();
  if(pass !== CONFIG.ADMIN_PASSWORD){ toast("Sai m·∫≠t kh·∫©u Admin."); return; }
  if(!confirm("Reset to√†n b·ªô? (X√≥a t·∫•t c·∫£ t√†i kho·∫£n & k·∫øt qu·∫£)")) return;

  store.users = {};
  saveStore();

  await webappPost({ action:"resetAll", ts: nowTs() });
  await syncFromServer();

  toast("ƒê√£ reset to√†n b·ªô.");
  renderAdminTables();
  renderDash();
  showView("admin");
  setAdminTab("accounts");
}

/* =========================================================
   Login / Logout (‚úÖ login syncFromServer)
   ========================================================= */
function setAvatarPick(a){
  session.avatar = a;
  saveSession();
  document.getElementById("pickM").classList.toggle("active", a==="M");
  document.getElementById("pickF").classList.toggle("active", a==="F");
}

async function doLogin(){
  const user = normUser(document.getElementById("loginUser").value);
  const pass = (document.getElementById("loginPass").value || "").trim();
  const avatar = session.avatar || "M";

  if(!user){ toast("Vui l√≤ng nh·∫≠p User AD."); return; }

  // ‚úÖ pull latest accounts/progress from server first
  if(getWebAppUrl()){
    await syncFromServer();
  }

  ensureUser(user);
  const u = getUser(user);

  const expected = (u.password || CONFIG.DEFAULT_USER_PASSWORD);
  if((pass || "") !== expected){
    toast("Sai m·∫≠t kh·∫©u. Vui l√≤ng ki·ªÉm tra l·∫°i.");
    return;
  }

  u.avatar = avatar;
  saveStore();

  session.user = user;
  saveSession();

  showView("home");
  renderHome();
}

function doLogout(){
  session.user = null;
  saveSession();
  showView("login");
}

/* =========================================================
   Admin login (‚úÖ admin syncFromServer)
   ========================================================= */
function openAdmin(){ showView("adminLogin"); }

async function adminLogin(){
  const pass = (document.getElementById("adminPass").value || "").trim();
  if(pass !== CONFIG.ADMIN_PASSWORD){
    toast("Sai m·∫≠t kh·∫©u Admin.");
    return;
  }

  // ‚úÖ always sync before showing dashboard/tables
  if(getWebAppUrl()){
    await syncFromServer();
  }

  showView("admin");
  document.getElementById("cfgWebAppUrl").value = getWebAppUrl();
  document.getElementById("cfgFormUrl").value = getFormUrl();
  document.getElementById("viewFormLink").textContent = getFormUrl() ? getFormUrl() : "(ch∆∞a thi·∫øt l·∫≠p)";

  renderAdminTables();
  renderDash();
  setAdminTab("accounts");
}

/* =========================================================
   Wire events
   ========================================================= */
document.getElementById("pickM").addEventListener("click", ()=> setAvatarPick("M"));
document.getElementById("pickF").addEventListener("click", ()=> setAvatarPick("F"));

document.getElementById("btnLogin").addEventListener("click", doLogin);
document.getElementById("loginPass").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
document.getElementById("loginUser").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

document.getElementById("btnLogout").addEventListener("click", doLogout);
document.getElementById("btnAdmin").addEventListener("click", openAdmin);

document.getElementById("btnBack").addEventListener("click", ()=>{
  const shown = document.querySelector("[data-view].show")?.getAttribute("data-view");
  if(shown === "day" || shown === "complete") { showView("home"); renderHome(); return; }
  if(shown === "adminLogin" || shown === "admin") { showView("home"); renderHome(); return; }
  showView("home"); renderHome();
});

document.getElementById("btnGoCurrent").addEventListener("click", ()=>{
  const u = getUser(session.user);
  openDay(currentDay(u));
});

document.getElementById("btnCancelDay").addEventListener("click", ()=>{
  showView("home");
  renderHome();
});

document.getElementById("dayText").addEventListener("input", ()=>{
  const v = document.getElementById("dayText").value || "";
  document.getElementById("charHint").textContent = `${v.length}/800`;
});

document.getElementById("btnSubmitDay").addEventListener("click", submitDay);
document.getElementById("btnBackHome").addEventListener("click", ()=>{
  showView("home");
  renderHome();
});

document.getElementById("btnAdminLogin").addEventListener("click", adminLogin);
document.getElementById("adminPass").addEventListener("keydown", (e)=>{ if(e.key==="Enter") adminLogin(); });

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", async ()=>{
    const tab = t.getAttribute("data-tab");
    setAdminTab(tab);

    if(tab === "accounts"){
      if(getWebAppUrl()) await syncFromServer();
      renderAdminTables();
    }
    if(tab === "dash"){
      if(getWebAppUrl()) await syncFromServer();
      renderDash();
    }
    if(tab === "webapp"){
      document.getElementById("cfgWebAppUrl").value = getWebAppUrl();
      document.getElementById("cfgFormUrl").value = getFormUrl();
      document.getElementById("viewFormLink").textContent = getFormUrl() ? getFormUrl() : "(ch∆∞a thi·∫øt l·∫≠p)";
    }
  });
});

document.getElementById("btnUpsertUser").addEventListener("click", upsertUserFromAdmin);
document.getElementById("btnDownloadCSV").addEventListener("click", downloadSampleCSV);
document.getElementById("btnExportCSV").addEventListener("click", exportCSV);
document.getElementById("btnImportCSV").addEventListener("click", async ()=>{
  const f = document.getElementById("csvFile").files?.[0];
  if(!f){ toast("Vui l√≤ng ch·ªçn file CSV."); return; }
  await importCSVFile(f);
});

document.getElementById("btnSaveConfig").addEventListener("click", saveAdminConfig);
document.getElementById("btnTestWebApp").addEventListener("click", testWebApp);
document.getElementById("btnResetAll").addEventListener("click", resetAll);

/* =========================================================
   Background canvas
   ========================================================= */
function drawBg(){
  const c = document.getElementById("bgCanvas");
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const w = Math.floor(window.innerWidth * dpr);
  const h = Math.floor(window.innerHeight * dpr);
  c.width = w; c.height = h;
  const ctx = c.getContext("2d");

  ctx.clearRect(0,0,w,h);

  const grad = ctx.createLinearGradient(0,0,w,h);
  grad.addColorStop(0, "rgba(0,58,140,0.85)");
  grad.addColorStop(0.45, "rgba(0,174,239,0.70)");
  grad.addColorStop(1, "rgba(230,0,18,0.70)");
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,w,h);

  function blob(x,y,r,color){
    const g = ctx.createRadialGradient(x,y,0,x,y,r);
    g.addColorStop(0, color);
    g.addColorStop(1, "rgba(255,255,255,0)");
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fill();
  }
  blob(w*0.25, h*0.18, Math.min(w,h)*0.32, "rgba(255,255,255,0.28)");
  blob(w*0.78, h*0.72, Math.min(w,h)*0.36, "rgba(255,255,255,0.22)");
  blob(w*0.60, h*0.28, Math.min(w,h)*0.22, "rgba(255,255,255,0.18)");
}
window.addEventListener("resize", drawBg);

/* =========================================================
   Init (‚úÖ start with syncFromServer if URL exists)
   ========================================================= */
(async function init(){
  drawBg();
  setAvatarPick(session.avatar || "M");

  // ‚úÖ initial sync (best effort)
  if(getWebAppUrl()){
    await syncFromServer();
  }

  if(session.user){
    showView("home");
    renderHome();
  }else{
    showView("login");
  }

  const updateAdminBtn = ()=>{
    document.getElementById("btnAdmin").style.display = session.user ? "inline-flex" : "none";
    document.getElementById("btnLogout").style.display = session.user ? "inline-flex" : "none";
  };
  updateAdminBtn();

  const obs = new MutationObserver(updateAdminBtn);
  obs.observe(document.body, { attributes:true, subtree:true, attributeFilter:["class"] });
})();
</script>
</body>
</html>
